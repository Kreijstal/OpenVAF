default:
  image: 'rust:latest'
  cache: &global_cache
    key: ${CI_COMMIT_REF_SLUG}

    paths:
      - .cargo/
      - target/

stages:
  - build
  - test
  - doc


workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH


variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  APT_CACHE_DIR: $CI_PROJECT_DIR/apt

build:
  stage: build
  script:
    - rustc --version
    - cargo --version
    - cargo build --verbose
  rules:
    - changes:
        - frontend/src/**.rs
        - macros/src/**.rs
        - rust_codegen/src/**.rs
        - frontend/src/Cargo.toml
        - macros/src/Cargo.toml
        - rust_codegen/src/Cargo.toml
        - Cargo.toml
test:
  stage: test
  script:
    - rustc --version
    - cargo --version
    - cd frontend
    - cargo test --verbose

  rules:
    - changes:
        - frontend/src/**.rs
        - macros/src/**.rs
        - rust_codegen/src/**.rs

test_fmt:
  stage: test

  before_script:
    - rustup component add rustfmt

  script:
    - cargo fmt -- --check

  rules:
    - changes:
        - frontend/src/**.rs
        - macros/src/**.rs
        - rust_codegen/src/**.rs

  cache:
    <<: *global_cache
    policy: pull



test_clippy:
  stage: test

  before_script:
    - rustup component add clippy

  script:
    - cargo clippy -- -D warnings

  rules:
    - changes:
        - frontend/src/**.rs
        - macros/src/**.rs
        - rust_codegen/src/**.rs




pages:
  image: "rustlang/rust:nightly"

  stage: doc
  script:
    - cargo doc --workspace --document-private-items
    - mkdir public
    - cp -R target/doc public/dev_doc
    - cargo doc --workspace
    - cp -R target/doc public/api_doc
    - echo '<meta http-equiv="refresh" content="0; url=open_vaf/index.html">' > public/api_doc/index.html
    - echo '<meta http-equiv="refresh" content="0; url=open_vaf/index.html">' > public/dev_doc/index.html

  artifacts:
    paths:
      - public

  rules:

    - changes:
        - frontend/src/**.rs
        - macros/src/**.rs
        - rust_codegen/src/**.rs
      if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH


  cache:
    <<: *global_cache
    key: documentation


